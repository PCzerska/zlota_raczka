<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Mapa OpenStreetMap - Zalogowany</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Panel boczny -->
            <div class="col-md-3 bg-light p-4 d-flex flex-column align-items-start">
                <h4>Złota Rączka</h4>
                <h2>Witaj, {{ imie }}</h2> <!-- Tutaj wyświetlamy imię użytkownika -->
                <hr>
                <button class="btn btn-primary btn-block mb-2" onclick="logout()">Wyloguj się</button>
                <button class="btn btn-success btn-block" onclick="add_offer()">Dodaj ogłoszenie</button>
                <div class="form-group">
                    <label for="bufferRadius">Promień bufora (m):</label>
                    <input type="range" class="form-control-range" id="bufferRadius" min="100" max="1000" step="100" value="1000" onchange="updateBufferRadius(this.value)">
                    <span id="bufferValue">1000 m</span>
                </div>
            </div>


            <!-- Mapa -->
            <div class="col-md-9" id="map" style="height: 100vh;">
            </div>
        </div>
    </div>

    <script>
        var map; // Zmienna przechowująca obiekt mapy
        var bufferCircle; // Zmienna przechowująca obiekt koła bufora

        // Inicjalizacja mapy
        function initMap() {
            map = L.map('map').setView([52.23249, 21.01011], 13); // Ustawienie początkowego zoomu na 13

            // Dodanie warstwy mapy z OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            showUserLocation(); // Wywołanie funkcji wyświetlającej lokalizację użytkownika
        }

        // Funkcja do wylogowywania
        function logout() {
            window.location.href = "/logout";
        }

        // Funkcja do dodawania ogłoszenia
        function add_offer() {
            window.location.href = "/add_offer";
        }

        // Funkcja do pobierania i wyświetlania lokalizacji użytkownika
        function showUserLocation() {
            if ("geolocation" in navigator) {
                // Pobierz aktualną lokalizację użytkownika
                navigator.geolocation.getCurrentPosition(function(position) {
                    var userLatitude = position.coords.latitude;
                    var userLongitude = position.coords.longitude;

                    // Utwórz znacznik na mapie w lokalizacji użytkownika
                    var userMarker = L.marker([userLatitude, userLongitude]).addTo(map);
                    userMarker.bindPopup("<b>Tu jesteś!</b>").openPopup();

                    // Narysuj początkowy filetowy bufor o promieniu 1000m wokół lokalizacji użytkownika
                    bufferCircle = L.circle([userLatitude, userLongitude], {
                        color: '#6633FF',
                        fillColor: '#6633FF',
                        fillOpacity: 0.2,
                        radius: 1000
                    }).addTo(map);

                    // Przesuń mapę do lokalizacji użytkownika
                    map.setView([userLatitude, userLongitude], 13);
                });
            } else {
                alert("Twoja przeglądarka nie obsługuje geolokalizacji.");
            }
        }

        // Funkcja do aktualizacji promienia bufora na podstawie wartości suwaka
        function updateBufferRadius(radius) {
            document.getElementById("bufferValue").innerText = radius + " m"; // Zaktualizuj wyświetlaną wartość promienia
            bufferCircle.setRadius(radius); // Ustaw nowy promień dla koła bufora
        }

        // Wywołaj funkcję initMap po załadowaniu strony
        window.onload = function() {
            initMap();
        };
    </script>

    <!-- Bootstrap JS, popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


</body>
</html>
